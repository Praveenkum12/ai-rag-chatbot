<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: radial-gradient(
          circle at top right,
          #1e1b4b,
          #0f172a,
          #020617
        );
        color: #f8fafc;
        min-height: 100vh;
      }
      h1,
      h2,
      h3,
      .font-outfit {
        font-family: "Outfit", sans-serif;
      }
      .glass {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .glass-dark {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }
      .chat-container::-webkit-scrollbar {
        width: 6px;
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      .btn-gradient {
        background: linear-gradient(135deg, #6366f1, #a855f7);
        transition: all 0.3s ease;
      }
      .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -10px rgba(168, 85, 247, 0.5);
      }
      .message-bot {
        border-bottom-left-radius: 2px;
      }
      .message-user {
        border-bottom-right-radius: 2px;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.2),
          rgba(168, 85, 247, 0.2)
        );
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease forwards;
      }
      .custom-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1rem;
        padding-right: 2rem;
      }
      .custom-select option {
        background-color: #0f172a;
        color: #f8fafc;
      }
    </style>
  </head>
  <body class="flex flex-col h-screen overflow-hidden">
    <!-- Header -->
    <header class="glass py-4 px-8 flex items-center justify-between z-10">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 btn-gradient rounded-xl flex items-center justify-center"
        >
          <i data-lucide="bot" class="text-white"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-tight">RAG</h1>
          <p class="text-xs text-indigo-300 font-medium">
            Powering your knowledge
          </p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button
          onclick="clearData()"
          class="p-2 glass rounded-lg hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition-colors"
          title="Clear Knowledge Base"
        >
          <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>
        <button
          onclick="toggleAnalytics()"
          class="p-2 glass rounded-lg hover:bg-white/10 text-slate-400 hover:text-white transition-all flex items-center gap-2"
          title="System Analytics"
        >
          <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
        </button>
        <!-- ADDED: Tool Showcase Button -->
        <div class="relative">
          <button
            onclick="toggleToolsMenu()"
            class="p-2 glass rounded-lg hover:bg-indigo-500/20 text-slate-400 hover:text-indigo-400 transition-all flex items-center gap-2"
            title="AI Tools & Capabilities"
          >
            <i data-lucide="sparkles" class="w-5 h-5"></i>
          </button>
          <!-- Tool Showcase Dropdown -->
          <div
            id="toolsMenu"
            class="hidden absolute right-0 mt-3 w-72 glass-dark rounded-2xl border border-white/10 p-5 shadow-2xl z-50 animate-fadeIn"
          >
            <h3
              class="text-sm font-bold font-outfit mb-4 flex items-center gap-2"
            >
              <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
              Real-time Capabilities
            </h3>
            <div class="space-y-4">
              <!-- Weather -->
              <div class="space-y-2">
                <div
                  class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                >
                  <i data-lucide="cloud-sun" class="w-3 h-3 text-blue-400"></i>
                  Weather
                </div>
                <button
                  onclick="useExample('whats the weather in delhi')"
                  class="w-full text-left text-xs p-2.5 rounded-xl bg-white/10 hover:bg-white/20 transition-colors text-slate-300 border border-white/5"
                >
                  "whats the weather in delhi"
                </button>
              </div>
              <!-- Time -->
              <div class="space-y-2">
                <div
                  class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                >
                  <i data-lucide="clock" class="w-3 h-3 text-purple-400"></i>
                  Global Time
                </div>
                <button
                  onclick="useExample('whats the time in new york')"
                  class="w-full text-left text-xs p-2.5 rounded-xl bg-white/10 hover:bg-white/20 transition-colors text-slate-300 border border-white/5"
                >
                  "whats the time in new york"
                </button>
              </div>
              <!-- Location -->
              <div class="space-y-2">
                <div
                  class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                >
                  <i data-lucide="map-pin" class="w-3 h-3 text-red-400"></i>
                  My Place
                </div>
                <button
                  onclick="useExample('where am i')"
                  class="w-full text-left text-xs p-2.5 rounded-xl bg-white/10 hover:bg-white/20 transition-colors text-slate-300 border border-white/5"
                >
                  "where am i right now?"
                </button>
              </div>
            </div>
            <div
              class="mt-4 pt-4 border-t border-white/5 text-[10px] text-slate-500 text-center italic"
            >
              AI automatically triggers these tools based on your question.
            </div>
          </div>
        </div>
        <div class="h-8 w-[1px] bg-white/10"></div>
        <div class="flex items-center gap-2">
          <button
            onclick="toggleHistoryDrawer()"
            class="p-2 glass rounded-lg hover:bg-white/10 text-slate-400 hover:text-white transition-all flex items-center gap-2"
            title="Chat History"
          >
            <i data-lucide="history" class="w-5 h-5"></i>
            <span class="text-xs font-medium hidden md:inline">History</span>
          </button>
          <div class="h-6 w-[1px] bg-white/10 mx-2"></div>
          <div class="flex flex-col items-end">
            <span
              id="displayUserName"
              class="text-xs font-bold text-white leading-none mb-1"
              >Guest User</span
            >
            <div class="flex items-center gap-2">
              <div
                class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"
              ></div>
              <span
                class="text-[10px] font-medium text-slate-400 uppercase tracking-widest"
                >System Ready</span
              >
            </div>
          </div>
        </div>
        <button
          onclick="logout()"
          class="p-2 glass rounded-lg hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition-colors ml-2"
          title="Logout"
        >
          <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <!-- HISTORY DRAWER OVERLAY -->
    <div
      id="drawerOverlay"
      onclick="toggleHistoryDrawer()"
      class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden transition-opacity duration-300 opacity-0"
    ></div>

    <!-- HISTORY DRAWER -->
    <div
      id="historyDrawer"
      class="fixed top-0 right-0 h-screen w-80 glass z-50 transform translate-x-full transition-transform duration-300 ease-out flex flex-col border-l border-white/10"
    >
      <div
        class="p-6 border-b border-white/10 flex items-center justify-between"
      >
        <h2 class="text-lg font-bold font-outfit flex items-center gap-2">
          <i data-lucide="history" class="w-5 h-5 text-indigo-400"></i>
          History
        </h2>
        <button
          onclick="toggleHistoryDrawer()"
          class="p-2 hover:bg-white/5 rounded-full text-slate-500 hover:text-white"
        >
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-4">
        <button
          onclick="
            startNewChat();
            toggleHistoryDrawer();
          "
          class="w-full py-3 px-4 glass border-indigo-500/30 hover:bg-indigo-500/20 text-indigo-400 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/10"
        >
          <i data-lucide="plus" class="w-4 h-4"></i>
          New Chat
        </button>
      </div>

      <div class="px-4 pb-4">
        <div class="relative group">
          <i
            data-lucide="search"
            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 group-focus-within:text-indigo-400 transition-colors"
          ></i>
          <input
            type="text"
            id="historySearch"
            oninput="handleHistorySearch(this.value)"
            placeholder="Search conversations..."
            class="w-full bg-white/5 border border-white/10 rounded-xl py-2 pl-10 pr-4 text-xs focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder:text-slate-600"
          />
        </div>
      </div>

      <div
        class="flex-1 overflow-y-auto px-4 pb-6 space-y-2"
        id="conversationList"
      >
        <!-- Conversations will be rendered here -->
      </div>

      <div class="p-4 border-t border-white/10">
        <button
          onclick="clearHistory()"
          class="w-full py-2.5 px-4 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all"
        >
          <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
          Clear All History
        </button>
      </div>
    </div>

    <main class="flex flex-1 overflow-hidden relative">
      <!-- Sidebar -->
      <aside
        class="w-80 border-r border-white/5 flex flex-col shrink-0 overflow-hidden bg-slate-950/20 backdrop-blur-md"
      >
        <!-- Knowledge Base Section -->
        <div class="p-6 flex flex-col h-full overflow-hidden">
          <div class="flex items-center justify-between mb-4">
            <h2
              class="text-xs font-semibold text-slate-500 uppercase tracking-widest"
            >
              Knowledge Base
            </h2>
            <button
              id="clearSelectionBtn"
              onclick="
                selectedDocIds = [];
                updateUI();
              "
              class="hidden p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-all mr-1"
              title="Clear Selection"
            >
              <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
            </button>
            <button
              onclick="toggleUpload()"
              class="p-2 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 rounded-lg transition-all"
              title="Upload Document"
            >
              <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
          </div>
          <!-- Filters -->
          <div class="mb-4">
            <div class="flex items-center gap-2">
              <select
                id="typeFilter"
                onchange="applyFilters()"
                class="custom-select flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] text-slate-300 focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500/50 cursor-pointer hover:bg-white/10 transition-all font-medium"
              >
                <option value="all">Document Type</option>
                <option value="pdf">PDF Files</option>
                <option value="md">Markdown</option>
                <option value="txt">Plain Text</option>
              </select>
              <select
                id="dateFilter"
                onchange="applyFilters()"
                class="custom-select flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] text-slate-300 focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500/50 cursor-pointer hover:bg-white/10 transition-all font-medium"
              >
                <option value="any">Any Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
              </select>
            </div>
          </div>

          <div
            id="docList"
            class="space-y-2 overflow-y-auto max-h-[calc(100vh-320px)] custom-scrollbar"
          >
            <!-- Documents will be list here -->
          </div>
        </div>
        <div class="mt-auto p-6 border-t border-white/5">
          <div class="p-4 glass rounded-xl space-y-2">
            <p class="text-xs text-slate-400">
              Vector DB: <span class="text-indigo-400">Chroma</span>
            </p>
            <p class="text-xs text-slate-400">
              Model: <span class="text-purple-400">gpt-4.1-nano</span>
            </p>
            <div
              id="tokenUsageContainer"
              class="pt-2 border-t border-white/5 hidden"
            >
              <p
                class="text-[10px] uppercase text-slate-500 font-bold tracking-tighter mb-1"
              >
                Request Stats
              </p>
              <div class="flex flex-col gap-1">
                <div class="flex items-center justify-between">
                  <span class="text-[9px] text-slate-500">Context:</span>
                  <span
                    id="tokenCount"
                    class="text-xs font-mono font-bold text-indigo-400"
                    >0 tokens</span
                  >
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-[9px] text-slate-500">History:</span>
                  <span
                    id="historyCount"
                    class="text-xs font-mono font-bold text-purple-400"
                    >0 msgs</span
                  >
                </div>
                <span
                  id="tokenWarning"
                  class="hidden text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded animate-pulse text-center mt-1"
                  >NEAR LIMIT</span
                >
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Chat Area -->
      <section class="flex-1 flex flex-col relative">
        <!-- Export Button -->
        <div class="absolute top-4 right-8 z-10 flex items-center gap-2">
          <button
            id="exportChatBtn"
            onclick="exportChat()"
            class="hidden glass px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2 border border-white/10"
          >
            <i data-lucide="download" class="w-4 h-4"></i>
            Export Chat
          </button>
        </div>
        <div
          id="chatContainer"
          class="chat-container flex-1 overflow-y-auto p-8 space-y-6 text-center"
        >
          <!-- Welcome View -->
          <div id="welcomeIntro" class="max-w-3xl mx-auto mt-12 mb-8">
            <h2 class="text-3xl font-bold mb-4 font-outfit">
              Hello! How can I help today?
            </h2>
            <p class="text-slate-400">
              Ask me anything about your uploaded documents. I'll provide
              answers with source citations.
            </p>
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-8 z-10">
          <div class="max-w-4xl mx-auto relative group">
            <div
              class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-focus-within:opacity-40 transition-opacity"
            ></div>
            <div class="relative flex items-center glass p-2 rounded-2xl">
              <input
                type="text"
                id="userInput"
                class="flex-1 bg-transparent border-none outline-none focus:ring-0 px-4 py-3 placeholder:text-slate-500"
                placeholder="Ask a question about your documents..."
              />
              <button
                onclick="sendMessage()"
                class="btn-gradient p-3 rounded-xl"
              >
                <i data-lucide="send" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Source View (Overlay) -->
      <div
        id="sourceModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden"
        onclick="closeSource()"
      >
        <div
          class="glass w-full max-w-2xl max-h-[80vh] rounded-3xl overflow-hidden animate-fadeIn"
          onclick="event.stopPropagation()"
        >
          <div
            class="p-6 border-b border-white/10 flex justify-between items-center"
          >
            <h3 class="text-xl font-bold font-outfit">Source Citation</h3>
            <button
              onclick="closeSource()"
              class="text-slate-400 hover:text-white"
            >
              <i data-lucide="x"></i>
            </button>
          </div>
          <div
            id="sourceContent"
            class="p-8 overflow-y-auto text-slate-300 leading-relaxed font-inter"
          ></div>
          <div class="p-4 bg-white/5 flex justify-between items-center">
            <div class="flex items-center gap-2">
              <span
                class="text-[10px] uppercase text-slate-500 font-bold tracking-widest"
                >Confidence</span
              >
              <div class="w-24 h-1.5 bg-white/10 rounded-full overflow-hidden">
                <div
                  id="sourceScoreBar"
                  class="h-full rounded-full animate-barFill"
                ></div>
              </div>
              <span
                id="sourceScoreText"
                class="text-xs font-mono font-bold"
              ></span>
            </div>
            <span
              id="sourceMeta"
              class="text-xs text-indigo-400 font-mono"
            ></span>
          </div>
        </div>
      </div>

      <!-- Upload Overlay -->
      <div
        id="uploadOverlay"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden"
        onclick="toggleUpload()"
      >
        <div
          class="glass w-full max-w-md p-10 rounded-3xl text-center animate-fadeIn"
          onclick="event.stopPropagation()"
        >
          <div
            class="mb-6 w-20 h-20 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto text-indigo-400"
          >
            <i data-lucide="upload-cloud" class="w-10 h-10"></i>
          </div>
          <h3 class="text-2xl font-bold mb-2 font-outfit">Upload Documents</h3>
          <p class="text-slate-400 mb-8 text-sm">
            Support for PDF, TXT, and Markdown files
          </p>

          <label class="block cursor-pointer">
            <div
              class="border-2 border-dashed border-white/10 rounded-2xl p-8 hover:border-indigo-500/50 transition-colors"
            >
              <i
                data-lucide="file-plus"
                class="w-8 h-8 mx-auto mb-3 text-slate-500"
              ></i>
              <span class="text-slate-300 block">Click to select file</span>
              <input
                type="file"
                id="fileInput"
                class="hidden"
                accept=".pdf,.txt,.md"
                onchange="handleUpload(event)"
              />
            </div>
          </label>

          <div id="uploadStatus" class="mt-4 text-sm font-medium"></div>

          <button
            onclick="toggleUpload()"
            class="mt-8 text-slate-500 hover:text-slate-300 text-sm font-medium"
          >
            Cancel
          </button>
        </div>
      </div>
    </main>

    <script>
      // AUTH PROTECTION
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "{}");

      if (!token) {
        window.location.href = "/static/login.html";
      }

      async function fetchAllData() {
        await fetchDocs();
        await fetchConversations();
      }

      window.onload = async () => {
        const display = document.getElementById("displayUserName");
        if (user) {
          display.textContent = user.name || user.email || "User";
        } else {
          display.textContent = "Guest User";
        }
        // Load initial data
        await fetchAllData();

        // Check for persisted conversation
        const savedConvId = localStorage.getItem("activeConversationId");
        if (
          savedConvId &&
          savedConvId !== "null" &&
          savedConvId !== "undefined"
        ) {
          console.log("Restoring session:", savedConvId);
          currentConversationId = savedConvId; // Set immediately to prevent race conditions
          await loadConversation(savedConvId);
        } else {
          startNewChat();
        }
      };

      function logout() {
        // Clear UI containers immediately
        const chat = document.getElementById("chatContainer");
        const convs = document.getElementById("conversationList");
        const docs = document.getElementById("docList");

        if (chat) chat.innerHTML = "";
        if (convs) convs.innerHTML = "";
        if (docs) docs.innerHTML = "";

        // Reset local state
        chatHistory = [];
        allFetchedDocs = [];
        currentConversationId = null;

        localStorage.clear();
        window.location.href = "/static/login.html";
      }

      function toggleHistoryDrawer() {
        const drawer = document.getElementById("historyDrawer");
        const overlay = document.getElementById("drawerOverlay");
        const isOpen = !drawer.classList.contains("translate-x-full");

        if (isOpen) {
          closeHistoryDrawer();
        } else {
          overlay.classList.remove("hidden");
          setTimeout(() => {
            drawer.classList.remove("translate-x-full");
            overlay.classList.remove("opacity-0");
          }, 10);
        }
      }

      function closeHistoryDrawer() {
        const drawer = document.getElementById("historyDrawer");
        const overlay = document.getElementById("drawerOverlay");
        if (drawer) drawer.classList.add("translate-x-full");
        if (overlay) {
          overlay.classList.add("opacity-0");
          setTimeout(() => overlay.classList.add("hidden"), 300);
        }
      }

      // CENTRALIZED API FETCH
      async function apiFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const headers = {
          ...options.headers,
          Authorization: `Bearer ${token}`,
        };

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401) {
          alert("Your session has expired. Please log in again.");
          logout();
          return null;
        }

        return response;
      }
    </script>
    <script>
      lucide.createIcons();
      let selectedDocIds = [];
      let allFetchedDocs = [];
      let activeFileType = "all";
      let activeDateFilter = "any";
      let chatHistory = []; // Our new memory box
      let currentConversationId = null; // Track current session

      function toggleToolsMenu() {
        const menu = document.getElementById("toolsMenu");
        menu.classList.toggle("hidden");
        // Close menu when clicking outside
        if (!menu.classList.contains("hidden")) {
          const closeListener = (e) => {
            if (
              !menu.contains(e.target) &&
              !e.target.closest('button[onclick="toggleToolsMenu()"]')
            ) {
              menu.classList.add("hidden");
              document.removeEventListener("click", closeListener);
            }
          };
          setTimeout(
            () => document.addEventListener("click", closeListener),
            10,
          );
        }
      }

      function useExample(q) {
        const input = document.getElementById("userInput");
        input.value = q;
        document.getElementById("toolsMenu").classList.add("hidden");
        sendMessage();
      }

      function clearSelection() {
        selectedDocIds = [];
        updateUI();
      }

      function updateUI() {
        try {
          document.querySelectorAll(".doc-item").forEach((item) => {
            const docId = item.getAttribute("data-doc-id");
            const badge = item.querySelector(".check-badge");
            if (selectedDocIds.includes(docId)) {
              item.classList.add("border-indigo-500/50", "bg-white/10");
              item.classList.remove("border-transparent");
              if (badge) badge.classList.remove("hidden");
            } else {
              item.classList.remove("border-indigo-500/50", "bg-white/10");
              item.classList.add("border-transparent");
              if (badge) badge.classList.add("hidden");
            }
          });

          const clearBtn = document.getElementById("clearSelectionBtn");
          if (clearBtn) {
            if (selectedDocIds.length > 0) {
              clearBtn.classList.remove("hidden");
            } else {
              clearBtn.classList.add("hidden");
            }
          }
          updateExportButton();
        } catch (error) {
          console.error("Error updating UI:", error);
        }
      }

      function updateExportButton() {
        const btn = document.getElementById("exportChatBtn");
        if (btn) {
          if (currentConversationId) {
            btn.classList.remove("hidden");
          } else {
            btn.classList.add("hidden");
          }
        }
      }

      function toggleDocSelection(docId) {
        const index = selectedDocIds.indexOf(docId);
        if (index > -1) {
          selectedDocIds.splice(index, 1);
        } else {
          selectedDocIds.push(docId);
        }
        updateUI();
      }

      function applyFilters() {
        activeFileType = document.getElementById("typeFilter").value;
        activeDateFilter = document.getElementById("dateFilter").value;
        renderDocs();
      }

      function renderDocs() {
        const container = document.getElementById("docList");
        container.innerHTML = "";

        const filteredDocs = allFetchedDocs.filter((doc) => {
          const typeMatch =
            activeFileType === "all" || doc.type === activeFileType;
          return typeMatch;
          // Note: Local date filtering is complex due to JS date parsing,
          // we'll rely on the backend for the actual search filtering.
        });

        if (filteredDocs.length === 0) {
          container.innerHTML =
            '<p class="text-slate-500 text-xs text-center py-4">No matching documents</p>';
          return;
        }

        filteredDocs.forEach((doc) => {
          const div = document.createElement("div");
          div.setAttribute("data-doc-id", doc.id);
          div.className =
            "doc-item group flex items-center gap-2 p-3 glass rounded-xl hover:bg-white/5 cursor-pointer transition-all border border-transparent";
          div.onclick = () => toggleDocSelection(doc.id);

          const isPDF = doc.type.toLowerCase().includes("pdf");
          const icon = isPDF
            ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path><text x="8" y="18" font-size="5" font-weight="bold" fill="currentColor" font-family="sans-serif">PDF</text></svg>`
            : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`;
          const iconColor = isPDF ? "text-red-400" : "text-indigo-400";
          const iconBg = isPDF ? "bg-red-400/5" : "bg-white/5";

          div.innerHTML = `
                <div class="relative w-10 h-10 flex items-center justify-center rounded-xl ${iconBg} ${iconColor}">
                    ${icon}
                    <div class="check-badge hidden absolute -top-1 -right-1 w-4 h-4 bg-indigo-500 rounded-full border-2 border-slate-900 flex items-center justify-center">
                        <svg class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-1 flex-1 overflow-hidden">
                    <div class="text-sm font-medium text-white truncate w-32">${doc.name}</div>
                    <div class="text-[10px] text-slate-500 mt-0.5 uppercase tracking-wider tabular-nums font-mono opacity-60">#${doc.id.substring(0, 8)}...</div>
                </div>
                <button 
                  onclick="event.stopPropagation(); deleteDoc('${doc.id}', '${doc.name}')"
                  class="p-2 opacity-0 group-hover:opacity-100 hover:bg-red-500/20 text-slate-500 hover:text-red-400 rounded-lg transition-all"
                  title="Delete Document"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
            `;
          container.appendChild(div);
        });
        updateUI();
      }

      // Load document list
      async function fetchDocs() {
        try {
          const res = await apiFetch("/documents");
          if (!res) return;
          allFetchedDocs = await res.json();
          renderDocs();
          lucide.createIcons();
        } catch (e) {
          console.error("Failed to fetch docs", e);
        }
      }

      async function loadConversation(id) {
        if (!id || id === "null" || id === "undefined") return;

        try {
          const res = await apiFetch(`/conversations/${id}`);
          if (!res) return;

          if (!res.ok) {
            console.error("Failed to load conversation:", id);
            localStorage.removeItem("activeConversationId");
            currentConversationId = null;
            startNewChat();
            return;
          }

          currentConversationId = id;
          localStorage.setItem("activeConversationId", id);

          // Reset Token Display when loading a different conversation
          const tokenContainer = document.getElementById("tokenUsageContainer");
          if (tokenContainer) tokenContainer.classList.add("hidden");
          const tokenCount = document.getElementById("tokenCount");
          if (tokenCount) tokenCount.textContent = "0 tokens";
          const warning = document.getElementById("tokenWarning");
          if (warning) warning.classList.add("hidden");

          const container = document.getElementById("chatContainer");
          container.innerHTML = "";
          container.classList.remove("text-center"); // Remove centering for chat messages

          closeHistoryDrawer();

          const data = await res.json();
          chatHistory = Array.isArray(data) ? data : data.messages || [];

          // Update message count in UI
          const histText = document.getElementById("historyCount");
          if (histText) histText.textContent = `${chatHistory.length} msgs`;

          if (chatHistory.length === 0) {
            appendWelcomeMessage();
          } else {
            chatHistory.forEach((msg) => {
              appendMessage(msg.role === "user" ? "user" : "bot", msg.content);
            });
          }

          fetchConversations(); // Update active highlight
          updateExportButton();
        } catch (e) {
          console.error("Error loading conversation:", e);
          localStorage.removeItem("activeConversationId");
          startNewChat();
        }
      }

      function appendWelcomeMessage() {
        const container = document.getElementById("chatContainer");
        container.classList.add("text-center");
        container.innerHTML = `
          <div id="welcomeIntro" class="max-w-3xl mx-auto mt-12 mb-8">
            <h2 class="text-3xl font-bold mb-4 font-outfit">Hello! How can I help today?</h2>
            <p class="text-slate-400">Ask me anything about your uploaded documents. I'll provide answers with source citations.</p>
          </div>
        `;
        lucide.createIcons();
      }

      function startNewChat() {
        currentConversationId = null;
        localStorage.removeItem("activeConversationId");
        chatHistory = [];
        appendWelcomeMessage();
        fetchConversations();
        updateExportButton();

        // Reset Token Display
        const container = document.getElementById("tokenUsageContainer");
        const countText = document.getElementById("tokenCount");
        const histText = document.getElementById("historyCount");
        const warning = document.getElementById("tokenWarning");

        if (container) container.classList.add("hidden");
        if (countText) countText.textContent = "0 tokens";
        if (histText) histText.textContent = "0 msgs";
        if (warning) warning.classList.add("hidden");
      }

      async function deleteDoc(docId, fileName) {
        if (!confirm(`Are you sure you want to delete "${fileName}"?`)) return;

        try {
          const res = await apiFetch(`/documents/${docId}`, {
            method: "DELETE",
          });
          if (!res) return;

          if (res.ok) {
            // Remove from selected list if it was there
            const index = selectedDocIds.indexOf(docId);
            if (index > -1) selectedDocIds.splice(index, 1);

            fetchDocs();
          } else {
            const err = await res.json();
            alert("Delete failed: " + err.detail);
          }
        } catch (err) {
          console.error("Delete error:", err);
          alert("Failed to delete document.");
        }
      }

      async function clearHistory() {
        if (
          !confirm(
            "Are you sure you want to delete your entire chat history? This cannot be undone.",
          )
        )
          return;

        try {
          const res = await apiFetch("/clear-chat-history", {
            method: "POST",
          });
          if (!res) return;

          if (res.ok) {
            startNewChat();
          } else {
            alert("Failed to clear history");
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function clearData() {
        if (
          !confirm(
            "Are you sure you want to clear all documents and the vector store? This action cannot be undone.",
          )
        ) {
          return;
        }

        console.log("Attempting to clear data...");
        try {
          const res = await apiFetch("/documents/clear", {
            method: "POST",
          });
          if (!res) return;

          console.log("Response status:", res.status);

          if (res.ok) {
            const data = await res.json();
            console.log("Server response:", data);
            alert(data.message);
            fetchDocs();
            document.getElementById("chatContainer").innerHTML = `
              <div class="max-w-3xl mx-auto text-center mt-12 mb-8">
                <h2 class="text-3xl font-bold mb-4 font-outfit">
                  Hello! How can I help today?
                </h2>
                <p class="text-slate-400">
                  Ask me anything about your uploaded documents. I'll provide
                  answers with source citations.
                </p>
              </div>
            `;
          } else {
            const err = await res.json();
            console.error("Clear failed:", err);
            alert("Error: " + (err.detail || "Unknown error"));
          }
        } catch (err) {
          console.error("Fetch error:", err);
          alert(
            "Failed to clear data - Please make sure you are on http://127.0.0.1:8000 (NOT port 5500)",
          );
        }
      }

      function toggleUpload() {
        const overlay = document.getElementById("uploadOverlay");
        overlay.classList.toggle("hidden");
      }

      async function handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const status = document.getElementById("uploadStatus");
        status.textContent = "Uploading and processing...";
        status.className = "mt-4 text-sm font-medium text-indigo-400";

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await apiFetch("/documents/upload", {
            method: "POST",
            body: formData,
          });
          if (!res) return;

          if (res.ok) {
            const data = await res.json();
            status.textContent =
              "Success! " + data.chunks_added + " chunks added.";
            status.className = "mt-4 text-sm font-medium text-green-400";
            fetchDocs();
            setTimeout(toggleUpload, 1500);
          } else {
            const err = await res.json();
            status.textContent = "Error: " + err.detail;
            status.className = "mt-4 text-sm font-medium text-red-400";
          }
        } catch (err) {
          status.textContent = "Upload failed";
          status.className = "mt-4 text-sm font-medium text-red-400";
        }
      }

      async function sendMessage() {
        const input = document.getElementById("userInput");
        const question = input.value.trim();
        if (!question) return;

        input.value = "";
        appendMessage("user", question);

        const botMsgId = "bot-" + Date.now();
        appendMessage("bot", "...", botMsgId);

        try {
          const res = await apiFetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              question,
              conversation_id: currentConversationId,
              doc_ids: selectedDocIds,
              file_type: activeFileType,
              date_filter: activeDateFilter,
              history: chatHistory,
            }),
          });
          if (!res) return;

          if (res.ok) {
            const data = await res.json();

            // Set session ID if this was the first message
            if (!currentConversationId) {
              currentConversationId = data.conversation_id;
              localStorage.setItem(
                "activeConversationId",
                currentConversationId,
              );
              fetchConversations();
              updateExportButton();
            }

            updateBotMessage(botMsgId, data.answer, data.sources);

            // Update Token Display
            if (data.token_usage) {
              const container = document.getElementById("tokenUsageContainer");
              const countText = document.getElementById("tokenCount");
              const histText = document.getElementById("historyCount");
              const warning = document.getElementById("tokenWarning");

              container.classList.remove("hidden");
              countText.textContent = `${data.token_usage} tokens`;

              // Show warning if over 4000 tokens (assuming 8k limit)
              if (data.token_usage > 4000) {
                warning.classList.remove("hidden");
              } else {
                warning.classList.add("hidden");
              }
            }

            // Add this turn to memory
            chatHistory.push({ role: "user", content: question });
            chatHistory.push({ role: "assistant", content: data.answer });

            // SUMMARIZATION LOGIC (The Smart Sliding Window)
            if (data.new_summary) {
              console.log("Applying Summarization...");
              // Keep only the summary and the very last 4 messages
              const recentMessages = chatHistory.slice(-4);
              chatHistory = [
                {
                  role: "assistant",
                  content: "[SUMMARY OF PREVIOUS CHAT]: " + data.new_summary,
                },
                ...recentMessages,
              ];
            } else if (chatHistory.length > 10) {
              chatHistory = chatHistory.slice(-10);
            }

            // Update history count UI with current memory size
            const histText = document.getElementById("historyCount");
            if (histText) {
              histText.textContent = `${chatHistory.length} msgs`;
            }
          } else {
            updateBotMessage(
              botMsgId,
              "I'm sorry, I don't know how to answer that based on the current system state. Please try again.",
            );
          }
        } catch (err) {
          updateBotMessage(botMsgId, "Connection error. Please try again.");
        }
      }

      function appendMessage(role, text, id = null) {
        const container = document.getElementById("chatContainer");
        const welcome = document.getElementById("welcomeIntro");
        if (welcome) {
          welcome.remove();
          container.classList.remove("text-center");
        }

        // Remove existing loading message if switching/reloading
        if (id && document.getElementById(id)) {
          document.getElementById(id).remove();
        }

        const div = document.createElement("div");
        div.className = `flex ${role === "user" ? "justify-end" : "justify-start"} animate-fadeIn w-full`;
        if (id) div.id = id;

        const inner = `
                <div class="max-w-2xl px-6 py-4 glass rounded-3xl ${role === "user" ? "message-user" : "message-bot"} relative">
                    <p class="whitespace-pre-wrap">${text}</p>
                    ${role === "bot" ? '<div class="sources mt-4 flex flex-wrap gap-2"></div>' : ""}
                </div>
            `;
        div.innerHTML = inner;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      function updateBotMessage(id, text, sources = []) {
        const msgDiv = document.getElementById(id);
        const p = msgDiv.querySelector("p");
        p.textContent = text;

        const sourcesDiv = msgDiv.querySelector(".sources");
        sourcesDiv.innerHTML = ""; // Clear existing

        if (sources && sources.length > 0) {
          sourcesDiv.innerHTML =
            '<span class="text-[10px] text-slate-500 w-full mb-1">Citations:</span>';
          sources.forEach((src, idx) => {
            const isTool = src.metadata.type === "tool";
            const conf = src.metadata.confidence || 0;

            let color = "";
            if (isTool) {
              color =
                "text-indigo-400 border-indigo-500/30 bg-indigo-500/5 hover:bg-indigo-500/10";
            } else {
              color =
                conf > 80
                  ? "text-green-400 border-green-500/30 bg-green-500/5 hover:bg-green-500/10"
                  : conf > 40
                    ? "text-yellow-400 border-yellow-500/30 bg-yellow-500/5 hover:bg-yellow-500/10"
                    : "text-red-400 border-red-500/30 bg-red-500/5 hover:bg-red-500/10";
            }

            const label = isTool
              ? src.metadata.filename
              : `Source [${idx + 1}]`;

            const btn = document.createElement("button");
            btn.className = `px-3 py-1.5 border rounded-full text-xs flex items-center gap-2 transition-all ${color}`;
            btn.innerHTML = `
              <span>${label}</span>
              ${!isTool ? `<span class="opacity-60 font-mono text-[10px]">${conf}%</span>` : ""}
            `;
            btn.onclick = () => showSource(src.content, src.metadata, idx + 1);
            sourcesDiv.appendChild(btn);
          });
        }
      }

      function showSource(content, meta, index) {
        const modal = document.getElementById("sourceModal");
        document.getElementById("sourceContent").textContent = content;

        const score = meta.confidence || 0;
        const colorClass =
          score > 80
            ? "bg-green-500"
            : score > 40
              ? "bg-yellow-500"
              : "bg-red-500";
        const textClass =
          score > 80
            ? "text-green-400"
            : score > 40
              ? "text-yellow-400"
              : "text-red-400";

        const bar = document.getElementById("sourceScoreBar");
        if (bar) {
          bar.style.width = score + "%";
          bar.className = `h-full rounded-full animate-barFill ${colorClass}`;
        }

        const scoreText = document.getElementById("sourceScoreText");
        if (scoreText) {
          scoreText.textContent = score + "%";
          scoreText.className = `text-xs font-mono font-bold ${textClass}`;
        }

        document.getElementById("sourceMeta").textContent =
          `${meta.filename} â€¢ Chunk ${index}`;
        modal.classList.remove("hidden");
      }

      function closeSource() {
        document.getElementById("sourceModal").classList.add("hidden");
      }

      document.getElementById("userInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      async function exportChat() {
        if (!currentConversationId) return;

        try {
          const res = await apiFetch(
            `/conversations/${currentConversationId}/export`,
          );
          if (!res) return;

          if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = `chat_export_${currentConversationId.substring(0, 8)}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
          } else {
            const err = await res.json();
            alert("Export failed: " + (err.detail || "Unknown error"));
          }
        } catch (e) {
          console.error(e);
          alert("Error exporting chat");
        }
      }

      async function handleHistorySearch(q) {
        if (!q || q.length < 2) {
          fetchConversations();
          return;
        }

        try {
          const res = await apiFetch(
            `/conversations-search?q=${encodeURIComponent(q)}`,
          );
          if (!res) return;
          const convs = await res.json();
          renderConversationList(convs);
        } catch (e) {
          console.error(e);
        }
      }

      function renderConversationList(convs) {
        const list = document.getElementById("conversationList");
        list.innerHTML = "";

        if (convs.length === 0) {
          list.innerHTML = `<p class="text-[10px] text-slate-500 text-center py-4">No conversations found</p>`;
          return;
        }

        convs.forEach((c) => {
          const div = document.createElement("div");
          div.className = `p-3 rounded-xl cursor-pointer transition-all border ${currentConversationId === c.id ? "bg-indigo-500/10 border-indigo-500/30" : "border-transparent hover:bg-white/5"}`;
          div.onclick = () => loadConversation(c.id);

          const date = new Date(c.updated_at);
          const dateStr = date.toLocaleDateString();
          const timeStr = date.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          div.innerHTML = `
            <div class="text-xs font-semibold text-slate-200 truncate mb-1">${c.title}</div>
            <div class="flex items-center justify-between text-[9px] text-slate-500 font-medium uppercase tracking-wider">
              <span>${dateStr}</span>
              <span>${timeStr}</span>
            </div>
          `;
          list.appendChild(div);
        });
        lucide.createIcons();
      }

      // Update fetchConversations to use cleaner render
      async function fetchConversations() {
        try {
          const res = await apiFetch("/conversations");
          if (!res) return;
          const convs = await res.json();
          renderConversationList(convs);
        } catch (e) {
          console.error(e);
        }
      }

      async function toggleAnalytics() {
        const modalId = "analyticsModal";
        let modal = document.getElementById(modalId);

        if (!modal) {
          modal = document.createElement("div");
          modal.id = modalId;
          modal.className =
            "fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4";
          modal.onclick = () => modal.classList.add("hidden");
          document.body.appendChild(modal);
        }

        if (!modal.classList.contains("hidden")) {
          modal.classList.add("hidden");
          return;
        }

        try {
          modal.innerHTML = `
            <div class="glass w-full max-w-lg rounded-3xl p-8 animate-fadeIn" onclick="event.stopPropagation()">
               <div class="flex justify-between items-center mb-8">
                  <h3 class="text-2xl font-bold font-outfit">Chat Insights</h3>
                  <button onclick="document.getElementById('analyticsModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                    <i data-lucide="x"></i>
                  </button>
               </div>
               <div class="grid grid-cols-2 gap-4 mb-8">
                  <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">Total Chats</div>
                    <div id="stat-chats" class="text-3xl font-bold text-indigo-400">...</div>
                  </div>
                  <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">Avg Length</div>
                    <div id="stat-avg" class="text-3xl font-bold text-purple-400">...</div>
                  </div>
                  <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">Total Msgs</div>
                    <div id="stat-msgs" class="text-3xl font-bold text-indigo-400">...</div>
                  </div>
                  <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-1">Facts Known</div>
                    <div id="stat-memories" class="text-3xl font-bold text-green-400">...</div>
                  </div>
               </div>
               <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Top Conversations</h4>
               <div id="top-convs" class="space-y-2"></div>
            </div>
          `;
          lucide.createIcons();
          modal.classList.remove("hidden");

          const res = await apiFetch("/analytics");
          if (!res) return;
          const data = await res.json();

          document.getElementById("stat-chats").textContent =
            data.total_conversations;
          document.getElementById("stat-msgs").textContent =
            data.total_messages;
          document.getElementById("stat-memories").textContent =
            data.total_memories;
          document.getElementById("stat-avg").textContent =
            data.avg_messages_per_chat;

          const topList = document.getElementById("top-convs");
          data.top_conversations.forEach((c) => {
            const row = document.createElement("div");
            row.className =
              "flex justify-between items-center p-3 bg-white/5 rounded-xl text-xs";
            row.innerHTML = `
                <span class="text-slate-300 truncate w-48">${c.title}</span>
                <span class="font-bold text-indigo-400">${c.count} msgs</span>
             `;
            topList.appendChild(row);
          });
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
