<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: radial-gradient(
          circle at top right,
          #1e1b4b,
          #0f172a,
          #020617
        );
        color: #f8fafc;
        min-height: 100vh;
      }
      h1,
      h2,
      h3,
      .font-outfit {
        font-family: "Outfit", sans-serif;
      }
      .glass {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .glass-dark {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .chat-container::-webkit-scrollbar {
        width: 6px;
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      .btn-gradient {
        background: linear-gradient(135deg, #6366f1, #a855f7);
        transition: all 0.3s ease;
      }
      .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -10px rgba(168, 85, 247, 0.5);
      }
      .message-bot {
        border-bottom-left-radius: 2px;
      }
      .message-user {
        border-bottom-right-radius: 2px;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.2),
          rgba(168, 85, 247, 0.2)
        );
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease forwards;
      }
    </style>
  </head>
  <body class="flex flex-col h-screen overflow-hidden">
    <!-- Header -->
    <header class="glass py-4 px-8 flex items-center justify-between z-10">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 btn-gradient rounded-xl flex items-center justify-center"
        >
          <i data-lucide="bot" class="text-white"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-tight">RAG</h1>
          <p class="text-xs text-indigo-300 font-medium">
            Powering your knowledge
          </p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <button
          onclick="toggleUpload()"
          class="p-2 glass rounded-lg hover:bg-white/10 transition-colors"
          title="Upload Document"
        >
          <i data-lucide="plus" class="w-5 h-5"></i>
        </button>
        <button
          onclick="clearData()"
          class="p-2 glass rounded-lg hover:bg-red-500/20 text-red-400 border-red-500/20 hover:border-red-500/40 transition-colors"
          title="Clear All Data"
        >
          <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>
        <div class="h-8 w-[1px] bg-white/10"></div>
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-sm font-medium text-slate-400">System Ready</span>
        </div>
      </div>
    </header>

    <main class="flex flex-1 overflow-hidden relative">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-80 glass-dark border-r border-white/5 flex flex-col hidden md:flex"
      >
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h2
              class="text-sm font-semibold uppercase tracking-wider text-slate-500"
            >
              Knowledge Base
            </h2>
            <button
              id="clearSelectionBtn"
              onclick="clearSelection()"
              class="text-[10px] text-indigo-400 hover:text-indigo-300 hidden transition-all font-medium uppercase tracking-tighter"
            >
              Clear All
            </button>
          </div>
          <div
            id="docList"
            class="space-y-2 overflow-y-auto max-h-[calc(100vh-250px)]"
          >
            <!-- Documents will be list here -->
          </div>
        </div>
        <div class="mt-auto p-6 border-t border-white/5">
          <div class="p-4 glass rounded-xl">
            <p class="text-xs text-slate-400 mb-2">
              Vector DB: <span class="text-indigo-400">Chroma</span>
            </p>
            <p class="text-xs text-slate-400">
              Model: <span class="text-purple-400">gpt-4.1-nano</span>
            </p>
          </div>
        </div>
      </aside>

      <!-- Chat Area -->
      <section class="flex-1 flex flex-col relative">
        <div
          id="chatContainer"
          class="chat-container flex-1 overflow-y-auto p-8 space-y-6"
        >
          <!-- Welcome Message -->
          <div class="max-w-3xl mx-auto text-center mt-12 mb-8">
            <h2 class="text-3xl font-bold mb-4 font-outfit">
              Hello! How can I help today?
            </h2>
            <p class="text-slate-400">
              Ask me anything about your uploaded documents. I'll provide
              answers with source citations.
            </p>
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-8 z-10">
          <div class="max-w-4xl mx-auto relative group">
            <div
              class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-focus-within:opacity-40 transition-opacity"
            ></div>
            <div class="relative flex items-center glass p-2 rounded-2xl">
              <input
                type="text"
                id="userInput"
                class="flex-1 bg-transparent border-none outline-none focus:ring-0 px-4 py-3 placeholder:text-slate-500"
                placeholder="Ask a question about your documents..."
              />
              <button
                onclick="sendMessage()"
                class="btn-gradient p-3 rounded-xl"
              >
                <i data-lucide="send" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Source View (Overlay) -->
      <div
        id="sourceModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden"
        onclick="closeSource()"
      >
        <div
          class="glass w-full max-w-2xl max-h-[80vh] rounded-3xl overflow-hidden animate-fadeIn"
          onclick="event.stopPropagation()"
        >
          <div
            class="p-6 border-b border-white/10 flex justify-between items-center"
          >
            <h3 class="text-xl font-bold font-outfit">Source Citation</h3>
            <button
              onclick="closeSource()"
              class="text-slate-400 hover:text-white"
            >
              <i data-lucide="x"></i>
            </button>
          </div>
          <div
            id="sourceContent"
            class="p-8 overflow-y-auto text-slate-300 leading-relaxed font-inter"
          ></div>
          <div class="p-4 bg-white/5 flex justify-end">
            <span
              id="sourceMeta"
              class="text-xs text-indigo-400 font-mono"
            ></span>
          </div>
        </div>
      </div>

      <!-- Upload Overlay -->
      <div
        id="uploadOverlay"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden"
        onclick="toggleUpload()"
      >
        <div
          class="glass w-full max-w-md p-10 rounded-3xl text-center animate-fadeIn"
          onclick="event.stopPropagation()"
        >
          <div
            class="mb-6 w-20 h-20 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto text-indigo-400"
          >
            <i data-lucide="upload-cloud" class="w-10 h-10"></i>
          </div>
          <h3 class="text-2xl font-bold mb-2 font-outfit">Upload Documents</h3>
          <p class="text-slate-400 mb-8 text-sm">
            Support for PDF, TXT, and Markdown files
          </p>

          <label class="block cursor-pointer">
            <div
              class="border-2 border-dashed border-white/10 rounded-2xl p-8 hover:border-indigo-500/50 transition-colors"
            >
              <i
                data-lucide="file-plus"
                class="w-8 h-8 mx-auto mb-3 text-slate-500"
              ></i>
              <span class="text-slate-300 block">Click to select file</span>
              <input
                type="file"
                id="fileInput"
                class="hidden"
                accept=".pdf,.txt,.md"
                onchange="handleUpload(event)"
              />
            </div>
          </label>

          <div id="uploadStatus" class="mt-4 text-sm font-medium"></div>

          <button
            onclick="toggleUpload()"
            class="mt-8 text-slate-500 hover:text-slate-300 text-sm font-medium"
          >
            Cancel
          </button>
        </div>
      </div>
    </main>

    <script>
      lucide.createIcons();
      let selectedDocIds = [];

      function clearSelection() {
        selectedDocIds = [];
        updateUI();
      }

      function updateUI() {
        const items = document.querySelectorAll(".doc-item");
        items.forEach((item) => {
          const docId = item.getAttribute("data-doc-id");
          if (selectedDocIds.includes(docId)) {
            item.classList.add(
              "ring-2",
              "ring-indigo-500/50",
              "bg-white/5",
              "border-indigo-500/30",
            );
            item.querySelector(".check-icon").classList.remove("hidden");
          } else {
            item.classList.remove(
              "ring-2",
              "ring-indigo-500/50",
              "bg-white/5",
              "border-indigo-500/30",
            );
            item.querySelector(".check-icon").classList.add("hidden");
          }
        });

        const clearBtn = document.getElementById("clearSelectionBtn");
        if (selectedDocIds.length > 0) {
          clearBtn.classList.remove("hidden");
        } else {
          clearBtn.classList.add("hidden");
        }
      }

      function toggleDocSelection(docId) {
        const index = selectedDocIds.indexOf(docId);
        if (index > -1) {
          selectedDocIds.splice(index, 1);
        } else {
          selectedDocIds.push(docId);
        }
        updateUI();
      }

      // Load document list
      async function fetchDocs() {
        try {
          const res = await fetch("/documents");
          const docs = await res.json();
          const container = document.getElementById("docList");
          container.innerHTML = "";

          if (docs.length === 0) {
            container.innerHTML =
              '<p class="text-slate-500 text-xs text-center py-4">No documents uploaded yet</p>';
            return;
          }

          docs.forEach((doc) => {
            const div = document.createElement("div");
            div.setAttribute("data-doc-id", doc.id);
            div.className =
              "doc-item flex items-center gap-3 p-3 glass rounded-xl hover:bg-white/5 cursor-pointer transition-all border border-transparent";
            div.onclick = () => toggleDocSelection(doc.id);
            div.innerHTML = `
                        <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-400 relative">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            <div class="check-icon hidden absolute -top-1 -right-1 w-3 h-3 bg-indigo-500 rounded-full flex items-center justify-center border border-slate-900">
                              <i data-lucide="check" class="w-2 h-2 text-white"></i>
                            </div>
                        </div>
                        <div class="flex-1 truncate">
                            <div class="text-sm font-medium truncate">${doc.name}</div>
                            <div class="text-[10px] text-slate-500 uppercase">${doc.type.replace(".", "")}</div>
                        </div>
                    `;
            container.appendChild(div);
          });
          updateUI();
          lucide.createIcons();
        } catch (e) {
          console.error("Failed to fetch docs", e);
        }
      }
      fetchDocs();

      async function clearData() {
        if (
          !confirm(
            "Are you sure you want to clear all documents and the vector store? This action cannot be undone.",
          )
        ) {
          return;
        }

        console.log("Attempting to clear data...");
        try {
          const res = await fetch("/documents/clear", {
            method: "POST",
          });

          console.log("Response status:", res.status);

          if (res.ok) {
            const data = await res.json();
            console.log("Server response:", data);
            alert(data.message);
            fetchDocs();
            document.getElementById("chatContainer").innerHTML = `
              <div class="max-w-3xl mx-auto text-center mt-12 mb-8">
                <h2 class="text-3xl font-bold mb-4 font-outfit">
                  Hello! How can I help today?
                </h2>
                <p class="text-slate-400">
                  Ask me anything about your uploaded documents. I'll provide
                  answers with source citations.
                </p>
              </div>
            `;
          } else {
            const err = await res.json();
            console.error("Clear failed:", err);
            alert("Error: " + (err.detail || "Unknown error"));
          }
        } catch (err) {
          console.error("Fetch error:", err);
          alert(
            "Failed to clear data - Please make sure you are on http://127.0.0.1:8000 (NOT port 5500)",
          );
        }
      }

      function toggleUpload() {
        const overlay = document.getElementById("uploadOverlay");
        overlay.classList.toggle("hidden");
      }

      async function handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const status = document.getElementById("uploadStatus");
        status.textContent = "Uploading and processing...";
        status.className = "mt-4 text-sm font-medium text-indigo-400";

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch("/documents/upload", {
            method: "POST",
            body: formData,
          });

          if (res.ok) {
            const data = await res.json();
            status.textContent =
              "Success! " + data.chunks_added + " chunks added.";
            status.className = "mt-4 text-sm font-medium text-green-400";
            fetchDocs();
            setTimeout(toggleUpload, 1500);
          } else {
            const err = await res.json();
            status.textContent = "Error: " + err.detail;
            status.className = "mt-4 text-sm font-medium text-red-400";
          }
        } catch (err) {
          status.textContent = "Upload failed";
          status.className = "mt-4 text-sm font-medium text-red-400";
        }
      }

      async function sendMessage() {
        const input = document.getElementById("userInput");
        const question = input.value.trim();
        if (!question) return;

        input.value = "";
        appendMessage("user", question);

        const botMsgId = "bot-" + Date.now();
        appendMessage("bot", "...", botMsgId);

        try {
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question,
              doc_ids: selectedDocIds.length > 0 ? selectedDocIds : null,
            }),
          });

          if (res.ok) {
            const data = await res.json();
            updateBotMessage(botMsgId, data.answer, data.sources);
          } else {
            updateBotMessage(
              botMsgId,
              "Sorry, I encountered an error processing your request.",
            );
          }
        } catch (err) {
          updateBotMessage(botMsgId, "Connection error. Please try again.");
        }
      }

      function appendMessage(role, text, id = null) {
        const container = document.getElementById("chatContainer");
        const div = document.createElement("div");
        div.className = `flex ${role === "user" ? "justify-end" : "justify-start"} animate-fadeIn`;
        if (id) div.id = id;

        const inner = `
                <div class="max-w-2xl px-6 py-4 glass rounded-3xl ${role === "user" ? "message-user" : "message-bot"} relative">
                    <p class="whitespace-pre-wrap">${text}</p>
                    ${role === "bot" ? '<div class="sources mt-4 flex flex-wrap gap-2"></div>' : ""}
                </div>
            `;
        div.innerHTML = inner;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      function updateBotMessage(id, text, sources = []) {
        const msgDiv = document.getElementById(id);
        const p = msgDiv.querySelector("p");
        p.textContent = text;

        if (sources && sources.length > 0) {
          const sourcesDiv = msgDiv.querySelector(".sources");
          sourcesDiv.innerHTML =
            '<span class="text-[10px] text-slate-500 w-full mb-1">Citations:</span>';
          sources.forEach((src, idx) => {
            const btn = document.createElement("button");
            btn.className =
              "px-3 py-1 bg-white/5 border border-white/10 rounded-full text-xs text-indigo-300 hover:bg-white/10 transition-colors";
            btn.textContent = `Source [${idx + 1}]`;
            btn.onclick = () => showSource(src.content, src.metadata);
            sourcesDiv.appendChild(btn);
          });
        }
      }

      function showSource(content, meta) {
        const modal = document.getElementById("sourceModal");
        document.getElementById("sourceContent").textContent = content;
        document.getElementById("sourceMeta").textContent =
          JSON.stringify(meta);
        modal.classList.remove("hidden");
      }

      function closeSource() {
        document.getElementById("sourceModal").classList.add("hidden");
      }

      document.getElementById("userInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    </script>
  </body>
</html>
